<!DOCTYPE html>
<html>
  <head>
    <title>Fate Dice</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="fate-core-glyphs.css">
    <style>
      html, body {
        padding: 0;
        margin: 0;
      }
      html {
        height: 100%;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 2em;
        color: #999;
        height: 100%;
      }
      a {
        color: #000;
        text-decoration: none;
        border-bottom: 1px dotted #999;
      }
      .main {
        text-align: center;
        display: flex;
        flex-direction: column;
        min-height: 100%;
      }

      .instructions {
        margin-bottom: 0;
      }

      .dice {
        font-size: 5rem;
        padding-top: 1rem;
        padding-bottom: 1rem;
        max-width: 15rem;
        margin-left: auto;
        margin-right: auto;
        cursor: pointer;
        color: #555;
      }

      .die {
        font-family: 'Fate Core Glyphs';
        display: inline-block;
      }

      .result,
      .form,
      .latest {
        margin-top: 1em;
        margin-bottom: 1em;
      }

      .result {
        color: #555;
      }

      .result-num {
        display: inline-block;
        text-align: right;
      }

      .roll-btn {
        padding: 1em;
      }

      .latest {
        font-size: .5em;
        max-width: 15rem;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
        flex-grow: 1;
      }

      .latest .result-num {
        width: 2em;
      }

      footer {
        font-size: .7rem;
        border-top: 1px solid #eee;
        padding: 1em;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <h4 class="instructions">Click to re-roll</h4>
      <div class="dice"></div>
      <div class="result"></div>
      <div class="latest"></div>

      <footer>
        Made by <a href="https://github.com/matita">matita</a> &middot;
        <a href="https://github.com/matita/fatedice">Source code</a><br>
        The Fate Core font is &copy; Evil Hat Productions, LLC and is used with permission. The Four Actions icons were designed by Jeremy Keller.
      </footer>
    </div>

    <script>
      var latest = []
      var display = {
        '-1': '-',
        '0' : '0',
        '1' : '+'
      }
      var scales = {
        'en': {
          '-2': 'terrible',
          '-1': 'poor',
          '0' : 'mediocre',
          '1' : 'average',
          '2' : 'fair',
          '3' : 'good',
          '4' : 'great',
          '5' : 'superb',
          '6' : 'fantastic',
          '7' : 'epic',
          '8' : 'legendary'
        },
        'it': {
          '-2': 'pessimo',
          '-1': 'scarso',
          '0' : 'mediocre',
          '1' : 'medio',
          '2' : 'discreto',
          '3' : 'buono',
          '4' : 'ottimo',
          '5' : 'eccellente',
          '6' : 'fantastico',
          '7' : 'epico',
          '8' : 'leggendario'
        }
      }
      var lang = navigator.language
      var scale = scales[lang] || scales[lang.split('-')[0]] || scales['en']
      var isRolling = false

      
      document.querySelector('.instructions').onclick = doRoll
      document.querySelector('.dice').onclick = doRoll
      doRoll()



      function doRoll() {
        if (isRolling)
          return
        isRolling = true
        var rolls = 5

        displayBlankResult()
        displayLatest()
        setTimeout(internalRoll, 100)

        function internalRoll() {
          var results = rollDice()
          displayDice(results)

          if (--rolls) {
            setTimeout(internalRoll, 100)
          } else {
            isRolling = false
            displayResult(results)
            saveResult(results)
          }
        }
      }

      function saveResult(results) {
        latest.unshift(results.slice())
      }

      function rollDie() {
        return Math.floor(Math.random() * 3) - 1
      }

      function rollDice() {
        var results = []
        for (var i = 0; i < 4; i++) {
          results[i] = rollDie()
        }
        return results
      }

      function sumDice(results) {
        return results.reduce(function (sum, d) { return sum + d }, 0)
      }

      function getTextResult (results) {
        var r = sumDice(results)
        var scaled = scale[r]
        return '<span class="result-num">' + (r > 0 ? '+' : '') + r + '</span>' +
          ' &middot; ' +
          '<span class="result-scaled">' + (scale[r] || '---') + '</span>'
      }

      function displayDice(results) {
        document.querySelector('.dice').innerHTML = results.map(function(d) {
          return '<div class="die">' + display[d] + '</div>'
        }).join('')
      }

      function displayBlankResult() {
        document.querySelector('.result').innerHTML = '---'
      }

      function displayResult(results) {
        document.querySelector('.result').innerHTML = getTextResult(results)
      }

      function displayLatest() {
        document.querySelector('.latest').innerHTML = latest.map(function (r) {
          return '<div class="latest-item">' + getTextResult(r) + '</div>'
        }).join('')
      }
    </script>
  </body>
</html>